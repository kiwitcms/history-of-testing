#!/bin/bash

set -eu

PREFIX="$(date +%B/%d)/"

if [ ! -d "$PREFIX" ]; then
    echo "INFO: Artifact directory $PREFIX not found. Nothing to do. Exiting."
    exit 1
fi


ARTIFACT_COUNT=$(find "$PREFIX" -mindepth 1 -maxdepth 1 -type d | wc -l)
ARTIFACT_DIRS=($(find "$PREFIX" -mindepth 1 -maxdepth 1 -type d))

echo "DEBUG: ARTIFACT_DIRS=${ARTIFACT_DIRS[@]}"

if [ "$ARTIFACT_COUNT" == "1" ]; then
    ARTIFACT_PATH=${ARTIFACT_DIRS[0]}
else
    YEAR=$(date +%y | cut -c2)
    INDEX=$(expr $YEAR % $ARTIFACT_COUNT)
    ARTIFACT_PATH="${ARTIFACT_DIRS[$INDEX]}"
fi

echo "DEBUG: ARTIFACT_PATH=$ARTIFACT_PATH"

FACT_YAML="$ARTIFACT_PATH/info.yaml"

# will exit if we get an error here
./bin/create-image $FACT_YAML

IMAGE="artifact.png"

if [[ -n "${AWS_ACCESS_KEY_ID:-}" && -n "${AWS_SECRET_ACCESS_KEY:-}" ]]; then
    s3cmd --acl-public put $IMAGE s3://history-of-testing/$ARTIFACT_PATH/$IMAGE
    IMAGE_URL="http://history-of-testing.s3.amazonaws.com/$ARTIFACT_PATH/$IMAGE"
fi

DESCRIPTION=$(yq -r ".description" $FACT_YAML | tr -s "\n" " ")
SHORT_DESCRIPTION=$(yq -r ".description" $FACT_YAML | tr -s "\n" " " | cut -f1 -d".")
SOURCE_URL=$(yq -r ".url" $FACT_YAML)
REPO_URL="https://github.com/kiwitcms/history-of-testing"

FULL_DESCRIPTION="$DESCRIPTION #HistoryOfTesting\n\nSource: $SOURCE_URL\nContribute: $REPO_URL"
echo
echo
echo "$FULL_DESCRIPTION"

TWITTER_DESCRIPTION="$SHORT_DESCRIPTION. #HistoryOfTesting\nSource: $SOURCE_URL\nContribute: $REPO_URL"
echo
echo
echo "$TWITTER_DESCRIPTION"
